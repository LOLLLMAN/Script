local juju = juju
local set_ragebot_target = juju and juju["set_ragebot_target"]
local players_service = cloneref(game:GetService("Players"))
local run_service = cloneref(game:GetService("RunService"))
local user_input_service = game:GetService("UserInputService")

local local_player = players_service.LocalPlayer

-- >> UI Overlay Setup
local screen_gui = Instance.new("ScreenGui")
screen_gui.IgnoreGuiInset = true
screen_gui.Parent = game:GetService("CoreGui") -- Can be changed to local_player.PlayerGui for better visibility

local frame = Instance.new("Frame")
local title = Instance.new("TextLabel")
local health_label = Instance.new("TextLabel")
local imageLabel = Instance.new("ImageLabel") -- ImageLabel for loading screen

frame.Parent = screen_gui
frame.Size = UDim2.new(1, 0, 1, 0)
frame.BackgroundColor3 = Color3.new(0, 0, 0)
frame.Visible = false -- Hidden initially

title.Parent = frame
title.Size = UDim2.new(1, 0, 0.2, 0)
title.BackgroundTransparency = 1
title.TextScaled = true
title.TextColor3 = Color3.new(1, 1, 1)
title.Text = "Waiting for target..."

health_label.Parent = frame
health_label.Size = UDim2.new(1, 0, 0.1, 0)
health_label.Position = UDim2.new(0, 0, 0.2, 0)
health_label.BackgroundTransparency = 1
health_label.TextScaled = true
health_label.TextColor3 = Color3.new(1, 1, 1)
health_label.Text = "Health: N/A"

-- Loading Image Setup
imageLabel.Parent = frame
imageLabel.Size = UDim2.new(1, 0, 1, 0) -- Fullscreen size
imageLabel.Position = UDim2.new(0, 0, 0, 0) -- Top-left corner
imageLabel.BackgroundTransparency = 1
imageLabel.ImageTransparency = 0.5
imageLabel.Image = "rbxassetid://83865652412880" -- Asset ID

-- Function to Find Player by Display Name
local function find_player(display_name)
    for _, player in ipairs(players_service:GetPlayers()) do
        if player.DisplayName == display_name then
            return player
        end
    end
    return nil
end

-- Function to Set Ragebot Target Dynamically
local function set_target()
    if not set_ragebot_target then
        return print("Error: set_ragebot_target function missing!")
    end
    
    local target_player = find_player(_G.RagebotConfig.target)
    
    if target_player then
        set_ragebot_target(target_player)
        frame.Visible = true -- Ensure UI appears when a target is found
        title.Text = "Target: " .. target_player.DisplayName
        print("Target set to: " .. target_player.DisplayName)
    else
        frame.Visible = false -- Hide UI if no target is found
        print("Target not found: " .. _G.RagebotConfig.target)
    end
end

-- Health Tracking Function
local function update_health(target_player)
    if target_player.Character then
        local humanoid = target_player.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            health_label.Text = "Health: " .. tostring(math.floor(humanoid.Health))
        else
            health_label.Text = "Health: N/A"
        end
    else
        health_label.Text = "Health: Dead"
    end
end

-- Monitor Character Health Changes
local function on_character_added(new_character, target_player)
    local humanoid = new_character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid:GetPropertyChangedSignal("Health"):Connect(function()
            update_health(target_player)
        end)
        update_health(target_player)
    end
end

-- Command Listener for Authorized Users
local function listen_for_commands()
    local function chat_listener(player)
        player.Chatted:Connect(function(message)
            local args = message:lower():gsub("%s+", ""):split(" ")

            -- Kill Switch Command
            if args[1] == ".stop" and table.find(_G.RagebotConfig.authorized_users, player.Name) then
                set_ragebot_target(nil)
                screen_gui:Destroy()
                print("Script stopped by " .. player.Name)
            end

            -- Change Target Command
            if args[1] == ".target" and args[2] and table.find(_G.RagebotConfig.authorized_users, player.Name) then
                _G.RagebotConfig.target = args[2]
                set_target()
                print("Target changed by " .. player.Name .. " to " .. args[2])
            end
        end)
    end

    -- Connect existing players
    for _, player in ipairs(players_service:GetPlayers()) do
        chat_listener(player)
    end

    -- Connect new players
    players_service.PlayerAdded:Connect(chat_listener)
end

-- Initialize
listen_for_commands()
set_target()

-- Cleanup
juju["on_unload"](function()
    set_ragebot_target(nil)
    screen_gui:Destroy()
    print("Ragebot script unloaded.")
end)
